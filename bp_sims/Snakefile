from hashlib import blake2b
import numpy as np

s_vals = [1e-1,1e-2,1e-3]
#mu_vals = [1e-7,1e-8,1e-9]
mu_vals = [1e-9]
dens_vals = [100]
L_vals = [10000]
sigma_vals = [10]
num_iter = [10000000]
replicates = np.arange(10)
samp_rate = [0.1]
samp_type_unif = ["uniform"]
samp_type_gaus = ["gaussian_w10","gaussian_w100","gaussian_w1000","gaussian_w10000","gaussian_w100000"]


def wildcards2seed(w,s,mu,dens,L,sigma,iter,r,rep) -> int:
    if w is not None:
    	filename = "s"+str(s)+"_mu"+str(mu)+"_rho"+str(dens)+"_L"+str(L)+"_sigma"+str(sigma)+"_iter"+str(iter)+"_r"+str(r)+"_gaussian_w"+str(w)+"_rep"+str(rep)+".p"
    else:
        filename = "s"+str(s)+"_mu"+str(mu)+"_rho"+str(dens)+"_L"+str(L)+"_sigma"+str(sigma)+"_iter"+str(iter)+"_r"+str(r)+"_uniform_rep"+str(rep)+".p"
    h = blake2b(filename.encode(),digest_size=4)
    return int.from_bytes(h.digest(),"big")

rule all:
    input:
        expand("results/{samp_type}/s{s_vals}_mu{mu_vals}/s{s_vals}_mu{mu_vals}_rho{dens_vals}_L{L_vals}_sigma{sigma_vals}_iter{num_iter}_r{samp_rate}_{samp_type}_rep{rep}.p",
               s_vals=s_vals,mu_vals=mu_vals,dens_vals=dens_vals,L_vals=L_vals,sigma_vals=sigma_vals,num_iter=num_iter,
               samp_rate=samp_rate,samp_type=samp_type_unif,rep=replicates),
        expand("results/{samp_type}/s{s_vals}_mu{mu_vals}/s{s_vals}_mu{mu_vals}_rho{dens_vals}_L{L_vals}_sigma{sigma_vals}_iter{num_iter}_r{samp_rate}_{samp_type}_rep{rep}.p",
               s_vals=s_vals,mu_vals=mu_vals,dens_vals=dens_vals,L_vals=L_vals,sigma_vals=sigma_vals,num_iter=num_iter,
               samp_rate=samp_rate,samp_type=samp_type_gaus,rep=replicates)

rule run_sims_uniform:
    input:
    output:
        p="results/uniform/s{s}_mu{mu}/s{s}_mu{mu}_rho{dens}_L{L}_sigma{sigma}_iter{iter}_r{r}_uniform_rep{rep}.p",
        zero="results/uniform/s{s}_mu{mu}/s{s}_mu{mu}_rho{dens}_L{L}_sigma{sigma}_iter{iter}_r{r}_uniform_rep{rep}.zero",
    params:
        seed=lambda wildcards: wildcards2seed(None,wildcards.s,wildcards.mu,wildcards.dens,wildcards.L,wildcards.sigma,wildcards.iter,wildcards.r,wildcards.rep)
    shell:
        """
        mkdir -p results/100M_iter/uniform
        start_time=$(date +%s)
        echo "Seed for output file {output.p}: {params.seed}" >> seeds_20240326.txt
        ~/.conda/envs/snakemake310/bin/python source/simulations.py -s {wildcards.s} --mu {wildcards.mu} --dens {wildcards.dens} -r {wildcards.r} \
            --sigma {wildcards.sigma} --num_iter {wildcards.iter} -L {wildcards.L} \
            --sampled_p_out {output.p} --seed {params.seed} --zero_out {output.zero}
        end_time=$(date +%s)
        echo "Execution time for output file {output.p}: $((end_time - start_time)) seconds" >> log_times_20240326.txt
        """

rule run_sims_gaussian:
    input:
    output:
        p="results/gaussian_w{w}/s{s}_mu{mu}/s{s}_mu{mu}_rho{dens}_L{L}_sigma{sigma}_iter{iter}_r{r}_gaussian_w{w}_rep{rep}.p",
        zero="results/gaussian_w{w}/s{s}_mu{mu}/s{s}_mu{mu}_rho{dens}_L{L}_sigma{sigma}_iter{iter}_r{r}_gaussian_w{w}_rep{rep}.zero",
    params:
       	seed=lambda wildcards: wildcards2seed(wildcards.w,wildcards.s,wildcards.mu,wildcards.dens,wildcards.L,wildcards.sigma,wildcards.iter,wildcards.r,wildcards.rep)
    shell:
        """
        mkdir -p results/100M_iter/gaussian_w{wildcards.w}
        start_time=$(date +%s)
        echo "Seed for output file {output.p}: {params.seed}" >> seeds_20240326.txt
        ~/.conda/envs/snakemake310/bin/python source/simulations.py -s {wildcards.s} --mu {wildcards.mu} --dens {wildcards.dens} -r {wildcards.r} \
            --sigma {wildcards.sigma} --num_iter {wildcards.iter} -L {wildcards.L} \
            --sampled_p_out {output.p} --seed {params.seed} --gaussian -w {wildcards.w} --zero_out {output.zero}
        end_time=$(date +%s)
        echo "Execution time for output file {output.p}: $((end_time - start_time)) seconds" >> log_times_20240326.txt
        """

rule plot_sfs_unif:
    input:
        sfs="results/uniform/s{s}_n{n}_mu{mu}_rho{dens}_L{L}_maxcount{maxcount}_sigma{sigma}_seed{seed}_iter{iter}_r{r}_uniform.sfs",
    output:
        plot="plots/uniform/s{s}_n{n}_mu{mu}_rho{dens}_L{L}_maxcount{maxcount}_sigma{sigma}_seed{seed}_iter{iter}_r{r}_uniform.png",
    shell:
        """
        mkdir -p plots/uniform
        python source/plot_sim_sfs.py --sfs_file {input.sfs} --filename {output.plot} --plot_theory
        """

rule plot_sfs_gaussian:
    input:
        sfs="results/gaussian_w{w}/s{s}_n{n}_mu{mu}_rho{dens}_L{L}_maxcount{maxcount}_sigma{sigma}_seed{seed}_iter{iter}_r{r}_gaussian_w{w}.sfs"
    output:
        plot="plots/gaussian_w{w}/s{s}_n{n}_mu{mu}_rho{dens}_L{L}_maxcount{maxcount}_sigma{sigma}_seed{seed}_iter{iter}_r{r}_gaussian_w{w}.png"
    shell:
        """
        mkdir -p plots/gaussian_w{wildcards.w}
        python source/plot_sim_sfs.py --sfs_file {input.sfs} --filename {output.plot} --plot_theory --gaussian -w {wildcards.w} --sigma {wildcards.sigma}
        """
